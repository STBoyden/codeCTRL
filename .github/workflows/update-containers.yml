name: Auto-update Build Containers
on:
  push:
    branches: [main, update-containers/*]
  schedule:
    - cron: "0 */2 * * */1"

jobs:
  build-containers:
    if: github.repository_owner == 'STBoyden'
    strategy:
      fail-fast: false
      matrix:
        os:
          - debian-latest
          - debian-sid
          - fedora-latest
          - fedora-rawhide
          - rhel-7
          - rhel-8
          - rhel-latest
          - ubuntu-20-04
          - ubuntu-latest
    runs-on: ubuntu-22.04
    permissions:
      packages: write
    steps:
      - uses: actions/checkout@v3

      - uses: satackey/action-docker-layer-caching@v0.0.11
        with:
          key: ${{ matrix.os }}-{hash}
        continue-on-error: true

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ github.token }}

      - name: Build and push for ${{ matrix.os }}
        run: |
          set -x

          docker build ./.github/containers/${{ matrix.os }} \
            -t ghcr.io/stboyden/codectrl-pkg/${{ matrix.os }}:latest \
            -t ghcr.io/stboyden/codectrl-pkg/${{ matrix.os }}:${{ github.sha }}

          docker push ghcr.io/stboyden/codectrl-pkg/${{ matrix.os }}:latest
          docker push ghcr.io/stboyden/codectrl-pkg/${{ matrix.os }}:${{ github.sha }}
